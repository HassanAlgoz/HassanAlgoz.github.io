title=معالجة الخطأ المُبرمَج وإصلاح الغلط الإنشائي
date=2020-12-01
dir=rtl
lang=ar
----------------------
بسم الله الرحمن الرحيم.

# مقدمة
يعمل البرنامج بسلام، ثم بعد فترة ومن غير أي تعديل في النص البرمجي، تظهر مشاكل جديدة غير متوقَّعة! نضطر لإيقاف البرنامج وإصلاحه، ثم نطلقه ثانيةً فيلبث فترة من الزمان، ثم تأتي الشكاوي من المستخدمين!

ولمثل هذا السبب شرعت في البحث في مسألة الأخطاء البرمجية، وإليك خلاصة هذا البحث تحت هذه الخطوط العريضة:
- معيار صحَّة البرنامج
- الفرق بين الخطأ المُبرمَج والغلط الإنشائي
    - سبب الخلط بين الخطأ المُبرمَج والغلط الإنشائي
- معالجة الخطأ المُبرمَج
    - استرجاع حال ما قبل الإجراء
    - تسلسل الأخطاء
    - إيصال رسالة الخطأ
    - إهمال الخطأ المُبرمَج
- إصلاح الغلط الإنشائي
    - المرحلة الأولى: العلم بوجود الغلط
    - المرحلة الثانية: تتبع أصل الغلط
    - المرحلة الثالثة: إصلاح الغلط



# معيار صحَّة البرنامج
البرنامج إجراءات تعمل على بيانات؛ وصحة الإجراء أن تُصِّدق تفاصيلُه وصفَه.

![معرّف إجراء في لغة جو](/assets/img/handle-errors-fix-bugs/go-func-signature.PNG)

الصورة توضح دالة/إجراء بوصفها (السطر الأول) وتفاصيلها (كل ما بداخلها). وتجد نفس النمط في لغات البرمجة بأشكال مختلفة.

والإجراء له وصفان: وصفٌ بلغة البرمجة، ووصفٌ بلغة الخطاب. فالأوَّل تفهمه الأدوات البرمجية فتساعدك في الكتابة والتعديل والقراءة، وهو الذي يتحوَّل إلى أوامِر تنفيذية، والثاني يفهمه المستخدم (المبرمج) ويُسمَّى التوثيق (documentation).

![https://golang.org/src/errors/errors.go](/assets/img/handle-errors-fix-bugs/go-func-docs.PNG)

وفي هذه الصورة: نرى السطرين الأوَّليْن يصفان بلغة الخطاب عمل هذا الإجراء، وهذا ما يُعرف بالتوثيق.

وبالتوثيق يُعرف مدى تأثر وتأثير الإجراء؛ فقد يتأثر بغير مُدخلاته، أو يؤثِّرُ هو بمدخلاته، أو يؤثّر في غير محلّ مخرجاته، ومثل ذلك يصعُب ضبطه فاجتنابه أسلم وأقرب للصحة.

والوصف بلغة البرمجة يحوي مُعرِّف الإجراء، وقيوداً أخرى.

فمُعرِّف الإجراء (function signature): هو ما يُميَّز به بين إجراءٍ وآخر، فمن ذلك: اسم الإجراء ومدخلاته ونوعها ومخرجاته ونوعها. فإذا اتفق اسمان، عرف البرنامج أي الإجرائين يُجري باختلاف الحدود الأخرى للمعرِّف. وهذا يُعرف باسم (function overloading). وقد تقيِّد اللغة المدخلات والمخرجات بما يزيد عن تحديد نوعها، وهو ما يُعرفُ بالتوكيد (assertion).

![التوكيدات والرمي في سويفت](/assets/img/handle-errors-fix-bugs/swift-throws-and-guard.PNG)

فنرى في الصورة أن لغة (سويفت) تستعمل للتوكيد مفردة (guard)، فيكون الشرط بصيغة الإثبات، فإن لم يتحقق صار إلى الرمي (throw)، كُلُّ قيْدٍ له خطأ. ولاحظ أن هذا هُنا يُعَدُّ من تفاصيل الإجراء. ولا بُدَّ أن تكون هذه القيود ظاهرة لمن سيستخدم الإجراء من غير أن يحتاج للنظر في تفاصيله. ولعل لغة (سويفت) تحلل النص البرمجي في تفاصيل الإجراء وتجعل هذه التوكيدات من وصفه بشكلٍ آلي.

فإذا قرأ المستخدم الوصفين (معرّف الدالة + التوثيق) عرف ما يأخذ الإجراء وما يُخرج، فلا يعطيه ما لا يقبل ولا يتوقَّع منه ما لا يضمن. وهو بذلك عندما يبني عليه، يبني على صحيح.


# الفرق بين الخطأ المُبرمَج والغلط الإنشائي 
ومن مُخرجات الإجراء: الخطأ (المُبرمَج). سواء خرج بالرجوع (return) أو بالرمي (throw).

**فالخطأ المُبرمَج**: يحدث حين تُفحص البيانات فيقرر أنها في حالة غير صالحة للمعالجة. مثلاً:  انقطاع الشبكة، أو فقدان ملفّ توقَّع في مكانٍ ما، أو إدخال عددٍ مكان حرفٍ، أو إدخال قيمة أكبر من الحد الأعلى، ..إلخ.

أما **الغلط في الإنشاء**: فإنَّه خروج البرنامج عما بُرمِجَ له. وهو غلط من أنشأ شيئًا من البرنامج، ولذلك فإنه حين يقع لا حوْل للبرنامج في معالجته إلا بالتوقُّف والإبلاغ عنه.

## سبب الخلط بين الخطأ المُبرمَج والغلط الإنشائي
وسبب الخلط بينهما لغاتٌ جعلت آلية معالجة الخطأ المُبرمَج تُمسك الغلط الإنشائي، مع أن البرنامج لا يستطيع معالجته إلا أن يستُرَ عليه ليُفسِد ويتفاقم، ومن هذه الأغلاط:
1. طلب معدومٍ (Null Dereference)
2. تحويل نوع خاطئ (Incorrect Casting)
3.	أخذ بيانات خارِجَ نطاق حاويها منه (Out-of-bounds Access Violation)
4. تنفيذ قسمة عدد على صِفر (Divide by Zero)
5. الدخول في تكرار لا نهائي (Infinite Loop)
6. تجاوُز حسابي علوي أو سفلي (Arithmetic Overflow or Underflow)
7. تكديس متجاوِز (Stack Overflow)
8. تمرير بيانات من نوع خاطئ (Invalid Argument)
9. عدم تعيين جميع المدخلات (Missing Argument)

فترى Java و Python وغيرها، تستعمل try-catch throw لهذه الأغلاط والأخطاء المُبرمَجة، وهذا غلطٌ إنشائي أصليّ في هذه اللغات، ولذلك فإن لغاتٍ حديثة أتت وتداركت هذا الغلط، مثل: Rust, Go على سبيل المثال لا الحصر.

# معالجة الخطأ المُبرمَج
فالإجراء له طريقان مع حدوث الخطأ فيه:

الأول: أن يُخرج الخطأ لمن يستدعيه، فيكون بذلك أسند معالجته إليه.

الثاني: أن يُعالِجه هو، ويخفي على المستدعي أنه حدث أصلاً.

وبحسب الخطأ نعالجه:
- نُعلم المستخدم بوجود الخطأ
- نعاود العملية مرة أخرى بعد فترة زمنية معيَّنة (وقد تكون باستخدام بيانات مختلفة)
- نستخدم بديلاً
- نستشير المستخدم
- نوقف البرنامج

## استرجاع حال ما قبل الإجراء
فإن كان الإجراء أتمَّ خُطُواتٍ أثَّرَت خارجه، فإن تأتَّى استرجاع الحال الأولى كان حسَناً وإلا فبرسالة خطأ تُنبئ عن ذلك، وإن كان الخروج بالخطأ لا يُفيد فعليك بإيقاف البرنامَج.

وتجد لذلك (finally) وهي ما يُنفَّذ في نهاية الأمر ولو أخطأ الإجراء إن كان دخل في (try)،  أو (defer) وتنفّذ ما أُعطيَت حين الخروج بترتيبٍ عكسي.

## تسلسل الأخطاء
فالأخطاء تكون متسلسلة، فمثلاً: "تعذر رفع الملف: تعذر الوصول للخادم: تعذر الاتصال بالشبكة"، هذا الخطأ سلسلة من ثلاثة أخطاء أصلُها "تعذر الاتصال بالشبكة"، فقد يعالج إجراءٌ هذا الخطأ بأن يُعاوِد رفع الملف بعد حين.

- سَلسَلة الأخطاء في نود: [node-verror](https://github.com/joyent/node-verror)
- سَلسَلة الأخطاء في جو: [go1.13-errors](https://blog.golang.org/go1.13-errors)

## إيصال رسالة الخطأ
وأبسط صور ذلك أن يكتب رسالة الخطأ كما هي للمستخدم ليراها وحسب.

وقد يُخيِّر البرنامج المستخدم؛ فيختار فيمشي البرنامج بناءً على اختياره.

لكن الخطأ قد لا يعني المستخدم، وإنما يعني المطوّر أو مدير النظام الذي يشتغل عليه البرنامج، فحينها يُكتب الخطأ بصيغة معيَّنة ويُحفظ في سجلّ (log)، وقد يستأذن البرنامجُ المستخدم في إرسال رسالة الخطأ للمعني به. ولا بد في هذه الرسالة أن تكون دالَّة قدر الإمكان على سبب الخطأ ومكانه وحال البرنامج حينه، لأن ذلك يُسهِّلُ معالجته.

## إهمال الخطأ المُبرمَج
الخطأ معلومة أقلُّ ما تفيده عدم تمام الإجراء المطلوب، وبالتالي فإن إهمال هذه المعلومة غلطٌ في إنشاء البرنامج، حيثُ لم يُستكمل منطقه، ثم تتفاجؤ بعد عمل البرنامج لفترة بوجود أخطاء غريبة وبتوقف البرنامج، وأشياء لم تتوقعها.

وإن كان لك الخيار، فلا تختر لغةً الأصل فيها الإهمال مثل: JavaScript, PHP, Python, وغيرها، بل اختر لغة تعينك لا لغة تغشُّك.

# إصلاح الغلط الإنشائي
وإني أحرِّص عليك أن لا تسوِّف معالجة ما تراه من علامات على وجود الأغلاط الإنشائية، لأنَّ ذلك يُنسى مع طول زمن المشروع، كما أنه بتراكمه يصعب معالجته لا كما لو أُصلح في حينه، وإن تُرك فإنه يكون سبباً لأغلاط أخرى، وهي مثله.

وإن كنت لا بُدَّ مؤجِّلاً؛ فسجّل الغلط وتاريخه وحال المشروع حينه حتى لا تنساه وحتى لا يخفى على من يأتي بعدك ممن لم يشهده معك.

## المرحلة الأولى: العلم بوجود الغلط
وعدوُّ ذلك أن يُمسكه فيكتمه ويُكمل، لأنه بذلك يُكنُّ فساداً يستشري إلى بقية أجزائه وقد يخرج إلى الأنظمة الأخرى المتصلة به، ثم قد لا يظهر إلا بعد إحداث أغلاطٍ إنشائية وأخطاءٍ مُبرمَجة أخرى، فيصعب حينئذٍ تتبع أصل الغلط لإصلاحه.

وهذا يعود بالدرجة الأولى للغة البرمجة (مفرداتها وأدواتها التي تحلل تركيباتها)، فمن الأغلاط الإنشائية ما يُمكن ضبطه بالتحليل الآلي للبرنامج المكتوب، ومنها ما يستحيل ضبطه لأنه صحيح التركيب لكن على وجهٍ لا يحقق المراد.

## المرحلة الثانية: تتبع أصل الغلط
 تفرز اللغة رسالة آليَّة تحتوي سلسلة الاستدعاءات التي كانت حين حدوث الغلط، واسم الملف ورقم السطر الذي حصل فيه.

ويُمكن استعمال المدقق (debugger) الذي يوقف البرنامج عند نقاط توقُّف محدده، ويُطْلعه على حال البرنامج عند تلك النقطة، كما يُمكّنه من التحكم في التنفيذ بالخطوِ خطوة واحدة أو الإكمال العادي حتى نقطة توقُّف قادمة.

أما استعمال الكتابة على السجلات الظاهرة باستعمال (console.log) أو (printf) ومثيلاتها بغرض التدقيق، فإن ذلك غالبًا ما يكون أفضل منه استعمال المدقق، ولذلك يَحسُن بالمبرمج تعلم استخدام مدقق لغته.

## المرحلة الثالثة: إصلاح الغلط
ولا نبدأ بالإصلاح إلا بعد تعيين أصل الغلط، ثم يكون موضِعُ الإصلاح ذلك الموضع لا غيره،  وقد يكون بإزالة أو إضافة أو تعديل أو تغيير ترتيب، ونحرص فيه أن نُصلِحَ ما يترتب على هذا الإصلاح من الأغلاط في مواضع أخرى.

وليس من الأمانة ترقيع الأغلاط، ولا إسكات الأخطاء، أو تعمُّد مخالفة وصف الإجراء لتفاصيله، أو افتعال الأغلاط أو تعمُّد الإنشاء الهشّ، فإنَّ فعل ذلك في البرمجيات مثل فعله في الإنشاءات (المباني).


-----

# التعليق
للتعليق على الموضوع، اكتب ردًّا تحت هذه التغريدة:
<blockquote class="twitter-tweet" data-lang="ar" data-dnt="true"><p lang="ar" dir="rtl">مقال: <a href="https://t.co/0Codk79PdN">https://t.co/0Codk79PdN</a><br>... بعد فترة ومن غير أي تعديل في النص البرمجي، تظهر مشاكل جديدة غير متوقَّعة! نضطر لإيقاف البرنامج وإصلاحه، ثم نطلقه ثانيةً فيلبث فترة من الزمان، ثم تأتي الشكاوي من المستخدمين!<br><br>للتعليق على الموضوع ردّ على هذه التغريدة</p>&mdash; حسان القوز (@Hassan_Algoz) <a href="https://twitter.com/Hassan_Algoz/status/1333636482687508480?ref_src=twsrc%5Etfw">١ ديسمبر ٢٠٢٠</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

# مصادر
- تفصيل دقيق ونقل تجربة فريدة: [نموذج الخطأ - مدوَّنة جو دفّي](http://joeduffyblog.com/2016/02/07/the-error-model/)
- نصائح عملية مفصَّلة: [معالجة الخطأ في نود - جوي نِت](https://www.joyent.com/node-js/production/design/errors)
- [معالجة الخطأ وجو](https://blog.golang.org/error-handling-and-go)
- [دليل لغة سويفت](https://docs.swift.org/swift-book/LanguageGuide/ErrorHandling.html)
- [ضمانات الشذوذ - ويكيبيديا](https://en.wikipedia.org/wiki/Exception_safety)